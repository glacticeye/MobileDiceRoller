<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Advanced 3D Dice Roller</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      overflow: hidden;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      color: white;
    }
    
    #dice-box {
      width: 100%;
      height: 100%;
      position: absolute;
      top: 0;
      left: 0;
      z-index: 1;
      background-image: url('/api/placeholder/1920/1080');
      background-size: cover;
      background-position: center;
    }
    
    /* UI Components */
    .panel {
      position: fixed;
      background: rgba(0, 0, 0, 0.8);
      border-radius: 10px;
      padding: 15px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
      z-index: 10;
      backdrop-filter: blur(5px);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    /* Main Controls */
    #dice-controls {
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 10px;
      max-width: 80%;
    }
    
    .dice-btn {
      padding: 12px 20px;
      background: linear-gradient(to bottom, #3a7bd5, #2b5876);
      border: none;
      border-radius: 8px;
      color: white;
      font-size: 18px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.2s;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
    }
    
    .dice-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 8px rgba(0, 0, 0, 0.4);
      background: linear-gradient(to bottom, #4a8fe0, #366b94);
    }
    
    .dice-btn:active {
      transform: translateY(0);
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }
    
    /* Results Panel */
    #results-panel {
      top: 20px;
      left: 20px;
      min-width: 200px;
    }
    
    #roll-result {
      font-size: 36px;
      font-weight: bold;
      text-align: center;
      margin: 10px 0;
      text-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
    }
    
    #roll-details {
      font-size: 14px;
      color: #aaa;
      margin-bottom: 10px;
    }
    
    /* Custom Roll Panel */
    #custom-roll-panel {
      top: 20px;
      right: 20px;
      display: flex;
      flex-direction: column;
      gap: 15px;
    }
    
    #custom-roll-panel input {
      padding: 8px 12px;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 5px;
      color: white;
      font-size: 16px;
    }
    
    #custom-roll-panel input:focus {
      outline: none;
      border-color: rgba(255, 255, 255, 0.4);
      background: rgba(255, 255, 255, 0.15);
    }
    
    #custom-roll-panel button {
      padding: 8px 15px;
      background: linear-gradient(to bottom, #3a7bd5, #2b5876);
      border: none;
      border-radius: 5px;
      color: white;
      font-weight: bold;
      cursor: pointer;
    }
    
    /* D&D Skill Check Panel */
    #skill-check-panel {
      bottom: 100px;
      left: 20px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    
    .form-group {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .form-group label {
      min-width: 80px;
    }
    
    .form-group input, .form-group select {
      flex: 1;
      padding: 6px 10px;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 5px;
      color: white;
    }
    
    #skill-check-panel button {
      padding: 8px 15px;
      background: linear-gradient(to bottom, #3a7bd5, #2b5876);
      border: none;
      border-radius: 5px;
      color: white;
      font-weight: bold;
      cursor: pointer;
      margin-top: 5px;
    }
    
    /* Roll History Panel */
    #history-panel {
      top: 20px;
      bottom: 20px;
      right: -300px;
      width: 250px;
      transition: right 0.3s ease;
      overflow-y: auto;
      padding-right: 5px;
    }
    
    #history-panel.visible {
      right: 20px;
    }
    
    #history-toggle {
      position: fixed;
      top: 20px;
      right: 20px;
      background: rgba(0, 0, 0, 0.8);
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      z-index: 15;
    }
    
    #history-toggle.active {
      background: #3a7bd5;
    }
    
    .history-item {
      margin-bottom: 10px;
      padding: 8px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 5px;
      border-left: 3px solid #3a7bd5;
    }
    
    .history-time {
      font-size: 12px;
      color: #888;
      margin-bottom: 5px;
    }
    
    .history-roll {
      font-weight: bold;
    }
    
    .history-result {
      color: #66ccff;
      float: right;
    }
    
    /* Roll success/failure animation */
    #result-modal {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) scale(0);
      z-index: 100;
      font-size: 3rem;
      font-weight: bold;
      text-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
      transition: transform 0.3s ease-out;
      pointer-events: none;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 1rem;
    }
    
    #result-modal.show {
      transform: translate(-50%, -50%) scale(1);
      animation: pulse 1.5s infinite alternate;
    }
    
    .passed {
      color: #2ecc71;
      text-shadow: 0 0 20px rgba(46, 204, 113, 0.8);
    }
    
    .failed {
      color: #e74c3c;
      text-shadow: 0 0 20px rgba(231, 76, 60, 0.8);
    }
    
    #particles-container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 90;
    }
    
    @keyframes pulse {
      0% {
        transform: translate(-50%, -50%) scale(1);
      }
      100% {
        transform: translate(-50%, -50%) scale(1.1);
      }
    }
    
    /* Presets panel */
    #presets-panel {
      bottom: 100px;
      right: 20px;
    }
    
    .preset-btn {
      display: block;
      width: 100%;
      padding: 8px 12px;
      margin-bottom: 8px;
      text-align: left;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 5px;
      color: white;
      cursor: pointer;
      transition: background 0.2s;
    }
    
    .preset-btn:hover {
      background: rgba(255, 255, 255, 0.2);
    }
    
    /* Help tooltip */
    .tooltip {
      position: relative;
      display: inline-block;
      margin-left: 5px;
      width: 16px;
      height: 16px;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 50%;
      text-align: center;
      line-height: 16px;
      font-size: 12px;
      cursor: help;
    }
    
    .tooltip:hover::after {
      content: attr(data-tip);
      position: absolute;
      left: 20px;
      top: -5px;
      width: 200px;
      padding: 5px 8px;
      background: rgba(0, 0, 0, 0.8);
      border-radius: 5px;
      font-size: 12px;
      z-index: 100;
      pointer-events: none;
    }
    
    /* Responsive adjustments */
    @media (max-width: 768px) {
      .panel {
        padding: 10px;
      }
      
      #dice-controls {
        max-width: 95%;
      }
      
      .dice-btn {
        padding: 10px 15px;
        font-size: 16px;
      }
      
      #roll-result {
        font-size: 28px;
      }
      
      #history-panel {
        width: 200px;
      }
    }
  </style>
</head>
<body>
  <div id="dice-box"></div>
  
  <!-- Results Panel -->
  <div id="results-panel" class="panel">
    <h3>Result</h3>
    <div id="roll-result">-</div>
    <div id="roll-details">Roll the dice to see results</div>
  </div>
  
  <!-- Custom Roll Panel -->
  <div id="custom-roll-panel" class="panel">
    <h3>Custom Roll</h3>
    <input type="text" id="custom-dice-notation" placeholder="e.g., 2d20+1d6+5" value="1d20">
    <button id="roll-custom-btn">Roll Custom</button>
  </div>
  
  <!-- D&D Skill Check Panel -->
  <div id="skill-check-panel" class="panel">
    <h3>D&D Skill Check</h3>
    <div class="form-group">
      <label for="skill-name">Skill:</label>
      <input type="text" id="skill-name" value="Perception">
    </div>
    <div class="form-group">
      <label for="skill-mod">Modifier:</label>
      <input type="number" id="skill-mod" value="2">
      <span class="tooltip" data-tip="Your character's skill modifier (e.g., Dexterity modifier + proficiency bonus)">?</span>
    </div>
    <div class="form-group">
      <label for="difficulty-class">DC:</label>
      <input type="number" id="difficulty-class" value="15">
      <span class="tooltip" data-tip="Difficulty Class - the target number you need to meet or exceed to succeed">?</span>
    </div>
    <button id="roll-skill-check-btn">Roll Skill Check</button>
  </div>
  
  <!-- Presets Panel -->
  <div id="presets-panel" class="panel">
    <h3>Presets</h3>
    <button class="preset-btn" data-dice="4d6kh3">Ability Score (4d6, keep highest 3)</button>
    <button class="preset-btn" data-dice="2d20kh1">Advantage (2d20, keep highest)</button>
    <button class="preset-btn" data-dice="2d20kl1">Disadvantage (2d20, keep lowest)</button>
    <button class="preset-btn" data-dice="8d6">Fireball (8d6)</button>
    <button class="preset-btn" data-dice="2d6+5">Greatsword+5 (2d6+5)</button>
  </div>
  
  <!-- Main Dice Controls -->
  <div id="dice-controls" class="panel">
    <button class="dice-btn" data-dice="d4">d4</button>
    <button class="dice-btn" data-dice="d6">d6</button>
    <button class="dice-btn" data-dice="d8">d8</button>
    <button class="dice-btn" data-dice="d10">d10</button>
    <button class="dice-btn" data-dice="d12">d12</button>
    <button class="dice-btn" data-dice="d20">d20</button>
    <button class="dice-btn" data-dice="d100">d100</button>
  </div>
  
  <!-- History Toggle Button -->
  <div id="history-toggle">H</div>
  
  <!-- Roll History Panel -->
  <div id="history-panel" class="panel">
    <h3>Roll History</h3>
    <div id="history-content"></div>
  </div>
  
  <!-- Roll Result Modal -->
  <div id="result-modal"></div>
  <div id="particles-container"></div>
  
  <script type="module">
    // Import the dice box library
    import DiceBox from "https://unpkg.com/@3d-dice/dice-box-threejs@0.0.12/dist/dice-box-threejs.es.js";
    
    // Initialize the 3D dice box
    const Box = new DiceBox("#dice-box", {
      scale: 6,
      throwForce: 6,
      gravity: 2,
      spinForce: 5,
      lightIntensity: 0.8,
      shadowTransparency: 0.6,
      theme: 'default'
    });
    
    // Initialize the box when the page loads
    Box.initialize().then(() => {
      document.getElementById("roll-details").textContent = "Dice ready! Click any button to roll.";
      console.log("Dice box initialized");
    }).catch(error => {
      console.error("Error initializing dice box:", error);
      document.getElementById("roll-details").textContent = "Error initializing dice. See console for details.";
    });
    
    // Roll history
    let rollHistory = [];
    const maxHistoryItems = 20;
    
    // Function to roll dice
    function rollDice(notation) {
      // Update display while rolling
      document.getElementById("roll-result").textContent = "Rolling...";
      document.getElementById("roll-details").textContent = notation;
      
      // Roll the dice
      Box.roll(notation).then(results => {
        console.log("Roll results:", results);
        
        // Process and display results
        const total = results.total;
        let breakdown = '';
        
        if (results.rolls && results.rolls.length > 0) {
          breakdown = results.rolls.map(roll => {
            return `${roll.dice}: [${roll.values.join(', ')}]`;
          }).join(' + ');
          
          if (results.modifier) {
            const modSign = results.modifier >= 0 ? '+' : '';
            breakdown += ` ${modSign}${results.modifier}`;
          }
        }
        
        // Update display with results
        document.getElementById("roll-result").textContent = total;
        document.getElementById("roll-details").textContent = breakdown;
        
        // Add to history
        addToHistory(notation, total, breakdown);
      }).catch(error => {
        console.error("Error rolling dice:", error);
        document.getElementById("roll-result").textContent = "Error";
        document.getElementById("roll-details").textContent = "Error rolling dice: " + error.message;
      });
    }
    
    // Function to perform a skill check
    function performSkillCheck() {
      const skillName = document.getElementById("skill-name").value || "Check";
      const skillMod = parseInt(document.getElementById("skill-mod").value) || 0;
      const difficultyClass = parseInt(document.getElementById("difficulty-class").value) || 10;
      
      // Construct dice notation
      const notation = `1d20+${skillMod}`;
      
      // Update display
      document.getElementById("roll-result").textContent = "Rolling...";
      document.getElementById("roll-details").textContent = `${skillName} check (DC ${difficultyClass})`;
      
      // Roll the dice
      Box.roll(notation).then(results => {
        const total = results.total;
        const passed = total >= difficultyClass;
        
        // Update display
        document.getElementById("roll-result").textContent = total;
        document.getElementById("roll-details").textContent = 
          `${skillName} check (DC ${difficultyClass}): ${passed ? 'SUCCESS' : 'FAILURE'}`;
        
        // Show success/failure animation
        showResultModal(passed, total, difficultyClass);
        
        // Add to history
        addToHistory(`${skillName} (DC ${difficultyClass})`, total, 
                      passed ? "Success" : "Failure");
      }).catch(error => {
        console.error("Error rolling dice:", error);
        document.getElementById("roll-result").textContent = "Error";
        document.getElementById("roll-details").textContent = "Error rolling dice: " + error.message;
      });
    }
    
    // Function to show success/failure modal with animation
    function showResultModal(passed, roll, threshold) {
      // Clear any existing modal content
      const resultModal = document.getElementById("result-modal");
      resultModal.innerHTML = "";
      resultModal.className = passed ? "passed" : "failed";
      
      // Add content
      resultModal.innerHTML = `
        <span>${passed ? "SUCCESS" : "FAILURE"}</span>
        <span>(${roll} vs ${threshold})</span>
      `;
      
      // Clear any existing particles
      const particlesContainer = document.getElementById("particles-container");
      particlesContainer.innerHTML = "";
      
      // Create particles
      createParticles(passed, particlesContainer);
      
      // Show the modal with animation
      setTimeout(() => {
        resultModal.classList.add("show");
      }, 500);
      
      // Auto-hide after a few seconds
      setTimeout(() => {
        resultModal.classList.remove("show");
      }, 3000);
    }
    
    // Function to create particles
    function createParticles(passed, container) {
      // Define colors based on success/failure
      const colors = passed ?
        ['#2ecc71', '#27ae60', '#a9dfbf', '#7dcea0', '#1abc9c'] :
        ['#e74c3c', '#c0392b', '#f5b7b1', '#cd6155', '#e67e22'];
      
      // Create a style element for keyframes
      const styleSheet = document.createElement("style");
      document.head.appendChild(styleSheet);
      
      let keyframesCSS = "";
      
      // Create particles
      for (let i = 0; i < 40; i++) {
        const particle = document.createElement("div");
        
        // Random size
        const size = Math.random() * 40 + 10;
        
        // Set styles
        particle.style.position = "absolute";
        particle.style.width = `${size}px`;
        particle.style.height = `${size}px`;
        particle.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
        particle.style.borderRadius = "50%";
        particle.style.top = "50%";
        particle.style.left = "50%";
        particle.style.opacity = Math.random() * 0.7 + 0.3;
        
        // Random end position
        const angle = Math.random() * Math.PI * 2;
        const distance = 100 + Math.random() * 300;
        const endX = Math.cos(angle) * distance;
        const endY = Math.sin(angle) * distance;
        
        // Animation properties
        const duration = Math.random() * 1.5 + 0.5;
        const delay = Math.random() * 0.2;
        
        // Set animation
        particle.style.animation = `particle-${i} ${duration}s ease-out ${delay}s forwards`;
        
        // Create keyframes
        keyframesCSS += `
          @keyframes particle-${i} {
            0% {
              transform: translate(-50%, -50%) scale(1);
              opacity: ${Math.random() * 0.7 + 0.3};
            }
            100% {
              transform: translate(calc(-50% + ${endX}px), calc(-50% + ${endY}px)) scale(0);
              opacity: 0;
            }
          }
        `;
        
        // Add particle to container
        container.appendChild(particle);
      }
      
      // Add central glow
      const glow = document.createElement("div");
      glow.style.position = "absolute";
      glow.style.width = "150px";
      glow.style.height = "150px";
      glow.style.borderRadius = "50%";
      glow.style.backgroundColor = "transparent";
      glow.style.boxShadow = passed ?
        "0 0 80px 40px rgba(46, 204, 113, 0.8)" :
        "0 0 80px 40px rgba(231, 76, 60, 0.8)";
      glow.style.top = "50%";
      glow.style.left = "50%";
      glow.style.transform = "translate(-50%, -50%)";
      glow.style.animation = "glow-fade 1.5s ease-out forwards";
      
      keyframesCSS += `
        @keyframes glow-fade {
          0% {
            opacity: 1;
            transform: translate(-50%, -50%) scale(0.8);
          }
          100% {
            opacity: 0;
            transform: translate(-50%, -50%) scale(1.5);
          }
        }
      `;
      
      container.appendChild(glow);
      
      // Add keyframes to stylesheet
      styleSheet.textContent = keyframesCSS;
      
      // Clean up after animations complete
      setTimeout(() => {
        container.innerHTML = "";
        document.head.removeChild(styleSheet);
      }, 3000);
    }
    
    // Function to add a roll to history
    function addToHistory(notation, result, details) {
      // Create history item
      const historyItem = {
        notation: notation,
        result: result,
        details: details,
        timestamp: new Date()
      };
      
      // Add to history array
      rollHistory.unshift(historyItem);
      
      // Limit history size
      if (rollHistory.length > maxHistoryItems) {
        rollHistory.pop();
      }
      
      // Update history display
      updateHistoryDisplay();
    }
    
    // Function to update history display
    function updateHistoryDisplay() {
      const historyContent = document.getElementById("history-content");
      historyContent.innerHTML = "";
      
      if (rollHistory.length === 0) {
        historyContent.innerHTML = "<p>No rolls yet</p>";
        return;
      }
      
      // Create elements for each history item
      rollHistory.forEach(item => {
        const historyItem = document.createElement("div");
        historyItem.className = "history-item";
        
        const time = new Date(item.timestamp).toLocaleTimeString();
        
        historyItem.innerHTML = `
          <div class="history-time">${time}</div>
          <div>
            <span class="history-roll">${item.notation}</span>
            <span class="history-result">${item.result}</span>
          </div>
          <div class="history-details">${item.details}</div>
        `;
        
        historyContent.appendChild(historyItem);
      });
    }
    
    // Set up event listeners
    document.addEventListener("DOMContentLoaded", () => {
      // Basic dice buttons
      document.querySelectorAll(".dice-btn").forEach(button => {
        button.addEventListener("click", () => {
          const dice = button.getAttribute("data-dice");
          rollDice(dice);
        });
      });
      
      // Custom roll button
      document.getElementById("roll-custom-btn").addEventListener("click", () => {
        const notation = document.getElementById("custom-dice-notation").value;
        if (notation.trim()) {
          rollDice(notation);
        }
      });
      
      // Skill check button
      document.getElementById("roll-skill-check-btn").addEventListener("click", performSkillCheck);
      
      // Preset buttons
      document.querySelectorAll(".preset-btn").forEach(button => {
        button.addEventListener("click", () => {
          const dice = button.getAttribute("data-dice");
          rollDice(dice);
        });
      });
      
      // History toggle
      document.getElementById("history-toggle").addEventListener("click", () => {
        const historyPanel = document.getElementById("history-panel");
        const historyToggle = document.getElementById("history-toggle");
        
        historyPanel.classList.toggle("visible");
        historyToggle.classList.toggle("active");
        
        // Update history if opening
        if (historyPanel.classList.contains("visible")) {
          updateHistoryDisplay();
        }
      });
      
      // Enter key in custom dice input
      document.getElementById("custom-dice-notation").addEventListener("keyup", (event) => {
        if (event.key === "Enter") {
          const notation = document.getElementById("custom-dice-notation").value;
          if (notation.trim()) {
            rollDice(notation);
          }
        }
      });
    });
    
    // Also attach event listeners immediately in case DOMContentLoaded already fired
    // Basic dice buttons
    document.querySelectorAll(".dice-btn").forEach(button => {
      button.addEventListener("click", () => {
        const dice = button.getAttribute("data-dice");
        rollDice(dice);
      });
    });
    
    // Custom roll button
    document.getElementById("roll-custom-btn").addEventListener("click", () => {
      const notation = document.getElementById("custom-dice-notation").value;
      if (notation.trim()) {
        rollDice(notation);
      }
    });
    
    // Skill check button
    document.getElementById("roll-skill-check-btn").addEventListener("click", performSkillCheck);
    
    // Preset buttons
    document.querySelectorAll(".preset-btn").forEach(button => {
      button.addEventListener("click", () => {
        const dice = button.getAttribute("data-dice");
        rollDice(dice);
      });
    });
    
    // History toggle
    document.getElementById("history-toggle").addEventListener("click", () => {
      const historyPanel = document.getElementById("history-panel");
      const historyToggle = document.getElementById("history-toggle");
      
      historyPanel.classList.toggle("visible");
      historyToggle.classList.toggle("active");
      
      // Update history if opening
      if (historyPanel.classList.contains("visible")) {
        updateHistoryDisplay();
      }
    });
    
    // Enter key in custom dice input
    document.getElementById("custom-dice-notation").addEventListener("keyup", (event) => {
      if (event.key === "Enter") {
        const notation = document.getElementById("custom-dice-notation").value;
        if (notation.trim()) {
          rollDice(notation);
        }
      }
    });
    
    // Roll a d20 automatically when loaded to demonstrate
    setTimeout(() => {
      rollDice("1d20");
    }, 1000);
  </script>
</body>
</html>
