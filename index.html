<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#1a1a2e">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>Mobile Dice Roller</title>
  <link rel="stylesheet" href="./src/styles.css">
</head>
<body>
  <div id="dice-box"></div>
  
  <div id="app-container">
    <!-- Header with result display -->
    <div id="header">
      <div style="width: 40px;"></div> <!-- Spacer for balance -->
      <div id="result-display">
        <div id="roll-result">-</div>
        <div id="roll-details">Roll the dice</div>
      </div>
      <div style="width: 40px;"></div> <!-- Spacer for balance -->
    </div>
    
    <!-- Main area for dice rolling -->
    <div id="main-area">
      <!-- Empty main area - removed selection display -->

    </div>
    
    <!-- Bottom dice controls -->
    <div id="dice-controls">
      <div class="dice-grid">
        <button class="dice-btn" id="roll-d4">d4 <span class="dice-count">0</span></button>
        <button class="dice-btn" id="roll-d6">d6 <span class="dice-count">0</span></button>
        <button class="dice-btn" id="roll-d8">d8 <span class="dice-count">0</span></button>
        <button class="dice-btn" id="roll-d10">d10 <span class="dice-count">0</span></button>
        <button class="dice-btn" id="roll-d12">d12 <span class="dice-count">0</span></button>
        <button class="dice-btn" id="roll-d20">d20 <span class="dice-count">0</span></button>
        <button class="dice-btn" id="roll-d100">% <span class="dice-count">0</span></button>
      </div>
      
      <!-- Roll and Clear buttons -->
      <div class="action-buttons">
        <button id="clear-btn">Clear</button>
        <button id="roll-btn">Roll</button>
      </div>
      
      <!-- Dice Style Toggle -->
      <div class="dice-style-toggle">
        <div class="toggle-label">Custom Dice:</div>
        <div class="toggle-container">
          <label class="toggle">
            <input type="checkbox" id="custom-dice-toggle">
            <span class="toggle-slider"></span>
            <span class="toggle-labels">
              <span class="toggle-label-left">ON</span>
            </span>
          </label>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Result Modal -->
  <div id="result-modal"></div>
  <div id="particles-container"></div>
  
  <script type="module">
    // Import the dice box library
    import DiceBox from "https://unpkg.com/@3d-dice/dice-box-threejs@0.0.12/dist/dice-box-threejs.es.js";
    
    // Initialize the 3D dice box
    const Box = new DiceBox("#dice-box", {
      assetPath: "assets/",
      framerate: (1/60),
      sounds: true,
      volume: 100,
      color_spotlight: null,
      shadows: true,
      theme_colorset: "white",
      sound_dieMaterial: null,
      theme_texture: null,
      theme_material: null,
      theme_surface: 'green-felt',
      theme_customColorset: null, // Add support for custom colorset
      gravity_multiplier: 400,
      // light_intensity: 1,
      baseScale: 150,
      strength: 2.5,
      onRollComplete: () => {},
      onAddDiceComplete: () => {},
      onRemoveDiceComplete: () => {}
    });
    
    // Variables to store DOM elements and dice counts
    let rollResult;
    let rollDetails;
    let selectionContainer;
    let currentSettings = {}; // Store current dice settings globally
    const diceSelections = {
      d4: 0,
      d6: 0,
      d8: 0,
      d10: 0,
      d12: 0,
      d20: 0,
      d100: 0
    };
    
    // Helper function to update the dice selection display
    function updateSelectionDisplay() {
      // Get total dice count
      const totalDiceCount = Object.values(diceSelections).reduce((sum, count) => sum + count, 0);
      
      // Check if any dice are selected
      const hasSelections = totalDiceCount > 0;
      
      // Create a string representation of the selection for roll details
      const selections = [];
      for (const [type, count] of Object.entries(diceSelections)) {
        if (count > 0) {
          selections.push(`${count}${type}`);
        }
      }
      
      // Update roll details to show current selection
      if (hasSelections) {
        rollDetails.textContent = selections.join(' + ');
      } else {
        rollDetails.textContent = "Roll the dice";
      }
      
      // Update all dice count displays
      for (const type of Object.keys(diceSelections)) {
        const countElement = document.querySelector(`#roll-${type} .dice-count`);
        if (countElement) {
          countElement.textContent = diceSelections[type];
          
          // Highlight buttons with selections
          const button = document.getElementById(`roll-${type}`);
          if (diceSelections[type] > 0) {
            button.classList.add('has-selection');
          } else {
            button.classList.remove('has-selection');
          }
        }
      }
      
      // Show/hide the roll button based on selections
      const rollButton = document.getElementById('roll-btn');
      if (hasSelections) {
        rollButton.classList.add('active');
      } else {
        rollButton.classList.remove('active');
      }
    }
    
    // Function to format the notation for dice rolling
    function formatDiceNotation() {
      const notations = [];
      
      for (const [type, count] of Object.entries(diceSelections)) {
        if (count > 0) {
          notations.push(`${count}${type}`);
        }
      }
      
      return notations.join('+');
    }
    
    // Initialize the box when the page loads
    document.addEventListener('DOMContentLoaded', () => {
      console.log("DOM loaded, initializing dice box...");
      
      rollResult = document.getElementById("roll-result");
      rollDetails = document.getElementById("roll-details");

      Box.initialize().then(() => {
        rollDetails.textContent = "Ready to roll";
        console.log("Dice box initialized");
      }).catch(error => {
        console.error("Error initializing dice box:", error);
        rollDetails.textContent = "Error loading dice";
      });
      
      // Set up event listeners
      setupEventListeners();
      
      // Set up settings button
      setupSettingsButton();
      
      // Initialize the selection display
      updateSelectionDisplay();
      
      // Load settings from localStorage
      loadDiceSettings();
      
      // Set up toggle event listener
      const customDiceToggle = document.getElementById('custom-dice-toggle');
      if (customDiceToggle) {
        // Initialize toggle state from localStorage
        try {
          const useCustomDice = localStorage.getItem('useCustomDice') === 'true';
          customDiceToggle.checked = useCustomDice;
          console.log('Initialized toggle state:', useCustomDice);
        } catch (e) {
          console.error('Error loading toggle state:', e);
        }
        
        // Listen for toggle changes
        customDiceToggle.addEventListener('change', () => {
          // Save toggle state
          localStorage.setItem('useCustomDice', customDiceToggle.checked);
          console.log('Toggle changed to:', customDiceToggle.checked);
          
          // Apply current settings with new toggle state
          applyDiceSettings(currentSettings);
        });
      }
      
      // Make sure we use the correct dice style based on toggle state
      // even when first loading the page
      setTimeout(() => {
        applyDiceSettings(currentSettings);
      }, 500);
      
      // Listen for settings changes when returning from settings page
      window.addEventListener('pageshow', (event) => {
        if (event.persisted) {
          loadDiceSettings();
        }
      });
    });
    
    // Function to set up event listeners
    function setupEventListeners() {
      // Dice selection buttons
      const diceButtons = document.querySelectorAll(".dice-btn");
      diceButtons.forEach(button => {
        const diceType = button.id.replace('roll-', '');
        
        button.addEventListener("click", () => {
          // Get total current dice count
          const totalDiceCount = Object.values(diceSelections).reduce((sum, count) => sum + count, 0);
          
          // Only increment if we're under the maximum (40 dice total)
          if (totalDiceCount < 40) {
            // Increment the count for this dice type
            diceSelections[diceType]++;
            
            // Update the display
            updateSelectionDisplay();
          } else {
            // Notify user of dice limit
            rollDetails.textContent = "Maximum of 40 dice reached";
            setTimeout(() => {
              updateSelectionDisplay();
            }, 1500);
          }
        });
      });
      
      // Roll button
      document.getElementById("roll-btn").addEventListener("click", () => {
        const notation = formatDiceNotation();
        if (notation) {
          rollDice(notation);
        }
      });
      
      // Clear button
      document.getElementById("clear-btn").addEventListener("click", () => {
        // Reset all dice selections
        for (const type in diceSelections) {
          diceSelections[type] = 0;
        }
        
        // Update the display
        updateSelectionDisplay();
        
        // Clear result
        rollResult.textContent = "-";
        rollDetails.textContent = "Roll the dice";
      });
      
      console.log("Event listeners set up");
    }
    
    // Function to roll dice
    function rollDice(notation) {
      // Check if box is initialized
      if (!Box) {
        console.error("Dice box not initialized");
        return;
      }
      
      // Get DOM elements if not already set
      if (!rollResult) rollResult = document.getElementById("roll-result");
      if (!rollDetails) rollDetails = document.getElementById("roll-details");
      
      // Update display while rolling
      rollResult.textContent = "Rolling...";
      rollDetails.textContent = notation;
      
      console.log("Rolling dice:", notation);
      
      // Roll the dice
      Box.roll(notation).then(results => {
        console.log("Roll results:", results);
        
        // Process and display results
        const total = results.total;
        let breakdown = '';
        
        if (results.rolls && results.rolls.length > 0) {
          breakdown = results.rolls.map(roll => {
            return `${roll.dice}: [${roll.values.join(', ')}]`;
          }).join(' + ');
          
          if (results.modifier) {
            const modSign = results.modifier >= 0 ? '+' : '';
            breakdown += ` ${modSign}${results.modifier}`;
          }
        }
        
        // Update display with results
        rollResult.textContent = total;
        rollDetails.textContent = breakdown || notation;
        
        // Check for critical rolls (natural 20s, etc.)
        checkForCriticals(results);
        
      }).catch(error => {
        console.error("Error rolling dice:", error);
        rollResult.textContent = "Error";
        rollDetails.textContent = "Error rolling dice";
      });
    }
    
    // Function to check for critical rolls
    function checkForCriticals(results) {
      if (!results.rolls) return;
      
      // Check for natural 20s
      const hasNatural20 = results.rolls.some(roll => 
        roll.dice === 'd20' && roll.values.includes(20)
      );
      
      // Check for natural 1s
      const hasNatural1 = results.rolls.some(roll => 
        roll.dice === 'd20' && roll.values.includes(1)
      );
      
      // Apply visual effect for criticals
      if (hasNatural20) {
        rollResult.classList.add('critical-success');
        setTimeout(() => {
          rollResult.classList.remove('critical-success');
        }, 2000);
      } else if (hasNatural1) {
        rollResult.classList.add('critical-fail');
        setTimeout(() => {
          rollResult.classList.remove('critical-fail');
        }, 2000);
      }
    }

    // Create settings button and add to header
    function setupSettingsButton() {
      // Create settings button
      const settingsBtn = document.createElement('button');
      settingsBtn.id = 'settings-btn';
      settingsBtn.innerHTML = '⚙️';
      settingsBtn.style.cssText = `
        background: none;
        border: none;
        color: white;
        font-size: 24px;
        cursor: pointer;
        padding: 5px;
      `;
      
      // Add settings button to header
      const header = document.getElementById('header');
      const spacer = header.querySelector('div[style="width: 40px;"]');
      if (spacer) {
        header.replaceChild(settingsBtn, spacer);
      } else {
        const resultDisplay = header.querySelector('#result-display');
        header.insertBefore(settingsBtn, resultDisplay);
      }
      
      // Add event listener to open settings page
      settingsBtn.addEventListener('click', () => {
        window.location.href = 'settings.html';
      });
    }

    // Function to load and apply dice settings
    function loadDiceSettings() {
      try {
        const savedSettings = localStorage.getItem('diceSettings');
        if (savedSettings) {
          const settings = JSON.parse(savedSettings);
          // Store the settings globally to access them later
          currentSettings = settings;
          // Apply the settings
          applyDiceSettings(settings);
        }
      } catch (e) {
        console.error('Error loading dice settings:', e);
      }
    }
    
    // Function to reset to default settings
    function resetToDefaultSettings() {
      // Default settings 
      const defaultSettings = {
        colorset: 'white', // White is the default color theme
        material: 'plastic',
        surface: 'green-felt',
        gravity: 100,
        strength: 1,
        volume: 100,
        shadows: true,
        sounds: true,
        baseScale: 100,
        customColorset: null // Ensure no custom colorset is used by default
      };
      
      // Apply default settings
      applyDiceSettings(defaultSettings);
      
      // Clear localStorage
      localStorage.removeItem('diceSettings');
      
      console.log('Reset to default settings');
    }

    // Function to apply dice settings to the DiceBox
    function applyDiceSettings(settings) {
      if (!Box) {
        console.error('Dice box not initialized');
        return;
      }
      
      const config = {};
      
      // Check the toggle state to determine which dice style to use
      const toggleElement = document.getElementById('custom-dice-toggle');
      
      // If the toggle element exists, use its state, otherwise check localStorage
      let useCustomDice;
      if (toggleElement) {
        useCustomDice = toggleElement.checked;
      } else {
        // If we're not on the page with the toggle, use the stored preference
        useCustomDice = localStorage.getItem('useCustomDice') === 'true';
      }
      
      console.log('Using custom dice:', useCustomDice);
      
      // Apply custom colorset if toggle is on and custom settings exist
      if (useCustomDice && settings.customColorset) {
        config.theme_customColorset = settings.customColorset;
        // When using custom colorset, clear the theme_colorset
        config.theme_colorset = null;
        console.log('Applied custom colorset');
      } else if (settings.colorset) {
        // When toggle is off or no custom dice, use theme colorset
        config.theme_colorset = settings.colorset;
        // Apply material
        if (settings.material) {
          config.theme_material = settings.material;
        }
        // When using theme colorset, clear any custom colorset
        config.theme_customColorset = null;
        console.log('Applied theme colorset:', settings.colorset);
      }
      
      // Apply gravity
      if (settings.gravity) {
        config.gravity_multiplier = settings.gravity;
      }
      
      // Apply toss strength
      if (settings.strength) {
        config.strength = settings.strength;
      }
      
      // Apply volume
      if (settings.volume !== undefined) {
        config.volume = settings.volume;
      }
      
      // Apply shadows
      if (settings.shadows !== undefined) {
        config.shadows = settings.shadows;
      }
      
      // Apply sounds
      if (settings.sounds !== undefined) {
        config.sounds = settings.sounds;
      }
      
      // Update the dice box with new settings
      Box.updateConfig(config);
      
      console.log('Applied dice settings:', settings);
    }
  </script>
</body>
</html>